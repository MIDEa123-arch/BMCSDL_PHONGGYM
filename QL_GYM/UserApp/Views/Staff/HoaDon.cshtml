@model IEnumerable<UserApp.ViewModel.InvoiceFullData>
@{
    ViewBag.Title = "HoaDon";
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold mb-3">
                <i class="bi bi-receipt"></i> Quản lý Hóa Đơn
            </h2>
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Tìm kiếm</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo mã HD, tên KH, SĐT...">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Từ ngày</label>
                    <input type="date" class="form-control" id="dateFrom">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Đến ngày</label>
                    <input type="date" class="form-control" id="dateTo">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Sắp xếp</label>
                    <select class="form-select" id="sortSelect">
                        <option value="date-desc">Ngày mới nhất</option>
                        <option value="date-asc">Ngày cũ nhất</option>
                        <option value="total-desc">Tổng tiền cao nhất</option>
                        <option value="total-asc">Tổng tiền thấp nhất</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="bi bi-funnel"></i> Lọc
                    </button>
                    <button class="btn btn-secondary" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise"></i> Đặt lại
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Danh sách hóa đơn -->
    <div id="invoiceList">
        @foreach (var invoice in Model)
        {
            <div class="card shadow-sm mb-3 invoice-item"
                 data-mahd="@invoice.Header.MAHD"
                 data-ngaylap="@invoice.Header.NGAYLAP.ToString("yyyy-MM-dd")"
                 data-tenkh="@invoice.Header.TENKH"
                 data-sdt="@invoice.Header.SDT"
                 data-thanhtien="@invoice.Header.THANHTIEN">
                <div class="card-header bg-primary bg-gradient text-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark-text"></i>
                                Hóa đơn #@invoice.Header.MAHD
                            </h5>
                            <small>Ngày lập: @invoice.Header.NGAYLAP.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <h5 class="mb-0">
                                Thành tiền: <span class="badge bg-warning text-dark">@invoice.Header.THANHTIEN.ToString("N0") đ</span>
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Thông tin khách hàng -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-1">
                                <i class="bi bi-person-fill text-primary"></i>
                                <strong>Khách hàng:</strong> @invoice.Header.TENKH
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1">
                                <i class="bi bi-telephone-fill text-success"></i>
                                <strong>Số điện thoại:</strong> @invoice.Header.SDT
                            </p>
                        </div>
                    </div>

                    <!-- Bảng chi tiết sản phẩm -->
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>STT</th>
                                    <th>Tên sản phẩm</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ int stt = 1; }
                                @foreach (var detail in invoice.Details)
                                {
                                    <tr>
                                        <td>@stt</td>
                                        <td>@detail.TENSP</td>
                                        <td class="text-center">@detail.SOLUONG</td>
                                        <td class="text-end">@detail.DONGIA.ToString("N0") đ</td>
                                        <td class="text-end fw-bold">@detail.THANHTIEN_SP.ToString("N0") đ</td>
                                    </tr>
                                    stt++;
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Tổng kết -->
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Tổng tiền:</strong></td>
                                    <td class="text-end">@invoice.Header.TONGTIEN.ToString("N0") đ</td>
                                </tr>
                                <tr>
                                    <td><strong>Giảm giá:</strong></td>
                                    <td class="text-end text-danger">-@invoice.Header.GIAMGIA.ToString("N0") đ</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Thành tiền:</strong></td>
                                    <td class="text-end fw-bold fs-5">@invoice.Header.THANHTIEN.ToString("N0") đ</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Các nút hành động -->
                    <div class="text-end mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="printInvoice(@invoice.Header.MAHD)">
                            <i class="bi bi-printer"></i> In hóa đơn
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewDetail(@invoice.Header.MAHD)">
                            <i class="bi bi-eye"></i> Chi tiết
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Thông báo không có dữ liệu -->
    <div id="noDataMessage" class="alert alert-info text-center" style="display: none;">
        <i class="bi bi-info-circle"></i> Không tìm thấy hóa đơn nào phù hợp với bộ lọc.
    </div>
</div>

<script>
    // Lọc hóa đơn
    function applyFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const sortBy = document.getElementById('sortSelect').value;

        let items = Array.from(document.querySelectorAll('.invoice-item'));
        let visibleCount = 0;

        // Lọc
        items.forEach(item => {
            const mahd = item.getAttribute('data-mahd');
            const ngaylap = item.getAttribute('data-ngaylap');
            const tenkh = item.getAttribute('data-tenkh').toLowerCase();
            const sdt = item.getAttribute('data-sdt');

            let show = true;

            // Tìm kiếm
            if (searchText && !mahd.includes(searchText) && !tenkh.includes(searchText) && !sdt.includes(searchText)) {
                show = false;
            }

            // Lọc từ ngày
            if (dateFrom && ngaylap < dateFrom) {
                show = false;
            }

            // Lọc đến ngày
            if (dateTo && ngaylap > dateTo) {
                show = false;
            }

            if (show) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        // Sắp xếp
        items = items.filter(item => item.style.display !== 'none');
        items.sort((a, b) => {
            switch(sortBy) {
                case 'date-desc':
                    return b.getAttribute('data-ngaylap').localeCompare(a.getAttribute('data-ngaylap'));
                case 'date-asc':
                    return a.getAttribute('data-ngaylap').localeCompare(b.getAttribute('data-ngaylap'));
                case 'total-desc':
                    return parseFloat(b.getAttribute('data-thanhtien')) - parseFloat(a.getAttribute('data-thanhtien'));
                case 'total-asc':
                    return parseFloat(a.getAttribute('data-thanhtien')) - parseFloat(b.getAttribute('data-thanhtien'));
            }
        });

        const container = document.getElementById('invoiceList');
        items.forEach(item => container.appendChild(item));

        // Hiển thị thông báo nếu không có dữ liệu
        document.getElementById('noDataMessage').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    // Đặt lại bộ lọc
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('sortSelect').value = 'date-desc';

        document.querySelectorAll('.invoice-item').forEach(item => {
            item.style.display = 'block';
        });

        document.getElementById('noDataMessage').style.display = 'none';
        applyFilters();
    }

    // In hóa đơn
    function printInvoice(mahd) {
        alert('Chức năng in hóa đơn #' + mahd);
        // Implement print logic here
    }

    // Xem chi tiết
    function viewDetail(mahd) {
        alert('Xem chi tiết hóa đơn #' + mahd);
        // Implement view detail logic here
    }

    // Tìm kiếm theo thời gian thực
    document.getElementById('searchInput').addEventListener('input', applyFilters);
</script>

<style>
    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

    .table-responsive {
        border-radius: 0.375rem;
    }

    .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }

    .bi {
        margin-right: 0.25rem;
    }
</style>