@model UserApp.Models.GrantViewModel
@{
    ViewBag.Title = "Quản trị Phân quyền";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<!-- Libraries -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="container-fluid py-4" style="font-family: 'Inter', sans-serif; background-color: #f8f9fc;">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800 font-weight-bold">Quản Trị Phân Quyền</h1>
            <p class="text-muted mb-0 mt-1">Quản lý quyền truy cập dữ liệu và chức vụ nhân viên.</p>
        </div>
        <div class="bg-white p-2 rounded shadow-sm border">
            <span class="text-success font-weight-bold"><i class="fas fa-circle fa-xs mr-2"></i>Hệ thống Online</span>
        </div>
    </div>

    <!-- KHỐI 1: PHÂN QUYỀN DỮ LIỆU (Xem/Thêm/Sửa/Xóa) -->
    @using (Html.BeginForm("PhanQuyen", "Admin", FormMethod.Post))
    {
        @Html.AntiForgeryToken()

        <div class="card shadow-sm mb-5 border-0 rounded-lg overflow-hidden">
            <div class="card-header bg-white py-3 border-bottom d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px;">
                    <i class="fas fa-database"></i>
                </div>
                <h5 class="m-0 font-weight-bold text-primary">1. Quyền Truy Cập Dữ Liệu</h5>
            </div>

            <div class="card-body bg-white">
                <!-- Thông báo kết quả -->
                @if (!string.IsNullOrEmpty(Model.Message))
                {
                    <div class="alert @(Model.MessageType == "success" ? "alert-success bg-success text-white border-0" : "alert-danger bg-danger text-white border-0") rounded-lg shadow-sm mb-4">
                        <i class="@(Model.MessageType == "success" ? "fas fa-check-circle" : "fas fa-exclamation-triangle") mr-2"></i>
                        @Model.Message
                    </div>
                }

                <div class="row">
                    <!-- Cột Trái: Chọn Đối Tượng (User hoặc Role) -->
                    <div class="col-lg-4 border-right">
                        <label class="text-xs font-weight-bold text-uppercase text-muted mb-3">Đối tượng áp dụng</label>

                        <div class="form-group">
                            <label class="font-weight-600 text-dark mb-1">Nhân viên cụ thể</label>
                            <div class="input-group input-group-lg">
                                <div class="input-group-prepend"><span class="input-group-text bg-light border-0"><i class="fas fa-user text-muted"></i></span></div>
                                @Html.DropDownListFor(m => m.SelectedUser, new SelectList(Model.Users), "--- Chọn nhân viên ---", new { @class = "form-control bg-light border-0", id = "ddlUser", onchange = "resetRole()" })
                            </div>
                        </div>

                        <div class="text-center my-3 text-muted text-xs font-weight-bold">HOẶC</div>

                        <div class="form-group">
                            <label class="font-weight-600 text-dark mb-1">Nhóm chức vụ</label>
                            <div class="input-group input-group-lg">
                                <div class="input-group-prepend"><span class="input-group-text bg-light border-0"><i class="fas fa-users text-muted"></i></span></div>
                                @Html.DropDownListFor(m => m.SelectedRole, new SelectList(Model.Roles), "--- Chọn nhóm chức vụ ---", new { @class = "form-control bg-light border-0", id = "ddlRole", onchange = "resetUser()" })
                            </div>
                        </div>
                    </div>

                    <!-- Cột Phải: Chọn Bảng & Hành động -->
                    <div class="col-lg-8 pl-lg-5">
                        <label class="text-xs font-weight-bold text-uppercase text-muted mb-3">Phạm vi truy cập</label>

                        <div class="form-group mb-4">
                            <label class="font-weight-600 text-dark mb-1">Dữ liệu cần thao tác</label>
                            @Html.DropDownListFor(m => m.SelectedTable, new SelectList(Model.Tables), "--- Chọn bảng dữ liệu ---", new { @class = "form-control form-control-lg border-primary shadow-sm", id = "SelectedTable", style = "height: 50px;" })
                        </div>

                        <label class="font-weight-600 text-dark mb-2">Hành động cho phép:</label>
                        <div class="row">
                            <!-- Card: Xem (SELECT) -->
                            <div class="col-md-3 col-6 mb-3">
                                <label class="permission-card cursor-pointer d-block p-3 rounded border text-center h-100 hover-shadow transition-300">
                                    @Html.CheckBoxFor(m => m.Select, new { @class = "d-none permission-checkbox" })
                                    <div class="icon-box mb-2 text-primary"><i class="fas fa-eye fa-2x"></i></div>
                                    <h6 class="font-weight-bold mb-1">Xem</h6>
                                    <small class="text-muted d-block">Tra cứu</small>
                                    <div class="check-indicator"><i class="fas fa-check-circle text-primary"></i></div>
                                </label>
                            </div>

                            <!-- Card: Thêm (INSERT) -->
                            <div class="col-md-3 col-6 mb-3">
                                <label class="permission-card cursor-pointer d-block p-3 rounded border text-center h-100 hover-shadow transition-300">
                                    @Html.CheckBoxFor(m => m.Insert, new { @class = "d-none permission-checkbox" })
                                    <div class="icon-box mb-2 text-success"><i class="fas fa-plus-circle fa-2x"></i></div>
                                    <h6 class="font-weight-bold mb-1">Thêm Mới</h6>
                                    <small class="text-muted d-block">Tạo mới</small>
                                    <div class="check-indicator"><i class="fas fa-check-circle text-success"></i></div>
                                </label>
                            </div>

                            <!-- Card: Sửa (UPDATE) -->
                            <div class="col-md-3 col-6 mb-3">
                                <label class="permission-card cursor-pointer d-block p-3 rounded border text-center h-100 hover-shadow transition-300">
                                    @Html.CheckBoxFor(m => m.Update, new { @class = "d-none permission-checkbox" })
                                    <div class="icon-box mb-2 text-warning"><i class="fas fa-edit fa-2x"></i></div>
                                    <h6 class="font-weight-bold mb-1">Chỉnh Sửa</h6>
                                    <small class="text-muted d-block">Cập nhật</small>
                                    <div class="check-indicator"><i class="fas fa-check-circle text-warning"></i></div>
                                </label>
                            </div>

                            <!-- Card: Xóa (DELETE) -->
                            <div class="col-md-3 col-6 mb-3">
                                <label class="permission-card cursor-pointer d-block p-3 rounded border text-center h-100 hover-shadow transition-300">
                                    @Html.CheckBoxFor(m => m.Delete, new { @class = "d-none permission-checkbox" })
                                    <div class="icon-box mb-2 text-danger"><i class="fas fa-trash-alt fa-2x"></i></div>
                                    <h6 class="font-weight-bold mb-1">Xóa Bỏ</h6>
                                    <small class="text-muted d-block">Xóa vĩnh viễn</small>
                                    <div class="check-indicator"><i class="fas fa-check-circle text-danger"></i></div>
                                </label>
                            </div>
                        </div>

                        <!-- Khu vực hiển thị quyền hiện có (AJAX Load) -->
                        <div class="mt-2 bg-light p-3 rounded d-flex align-items-center justify-content-between">
                            <span class="text-muted small font-weight-bold"><i class="fas fa-info-circle mr-1"></i> Quyền hạn hiện có:</span>
                            <div id="existingPrivilegesDisplay">
                                <span class="badge badge-soft-secondary p-2">Vui lòng chọn đối tượng...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer: Nút Thao Tác -->
            <div class="card-footer bg-light py-3 text-right">
                <button type="submit" name="actionType" value="GRANT" class="btn btn-primary btn-lg px-4 font-weight-bold shadow-sm rounded-pill mr-2">
                    <i class="fas fa-check mr-2"></i>Cấp Phép
                </button>
                <button type="submit" name="actionType" value="REVOKE" class="btn btn-outline-danger btn-lg px-4 font-weight-bold shadow-sm rounded-pill">
                    <i class="fas fa-ban mr-2"></i>Thu Hồi
                </button>
            </div>
        </div>
    }

    <!-- KHỐI 2: QUẢN LÝ CHỨC VỤ (Bổ nhiệm Role) -->
    <div class="card shadow-sm border-0 rounded-lg overflow-hidden">
        <div class="card-header bg-white py-3 border-bottom d-flex align-items-center">
            <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px;">
                <i class="fas fa-id-card-alt"></i>
            </div>
            <h5 class="m-0 font-weight-bold text-info">2. Bổ Nhiệm & Chức Vụ</h5>
        </div>

        <div class="card-body bg-light">
            @using (Html.BeginForm("GrantUserRole", "Admin", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <div class="row justify-content-center align-items-center py-4">

                    <!-- Chọn User -->
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-3">
                                <label class="text-xs font-weight-bold text-uppercase text-muted mb-2">Nhân viên</label>
                                @Html.DropDownList("userToGrant", new SelectList(Model.Users), "Chọn nhân viên...", new { @class = "form-control border-0 bg-light font-weight-bold", required = "required" })
                            </div>
                        </div>
                    </div>

                    <div class="col-md-1 text-center mb-3 mb-md-0">
                        <div class="bg-white rounded-circle shadow-sm d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="fas fa-arrow-right text-muted"></i>
                        </div>
                    </div>

                    <!-- Chọn Role (Có nút xem thành viên) -->
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-3">
                                <label class="text-xs font-weight-bold text-uppercase text-muted mb-2">Chức vụ mới</label>
                                <div class="input-group">
                                    @Html.DropDownList("roleToGrant", new SelectList(Model.Roles), "Chọn chức vụ...", new { @class = "form-control border-0 bg-light font-weight-bold", id = "roleToGrant", required = "required" })
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-light border-0 text-info" onclick="showUsersInRole()" title="Xem thành viên" style="background-color: #f8f9fc;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nút Bổ nhiệm / Bãi nhiệm -->
                    <div class="col-md-3 text-center">
                        <button type="submit" name="actionType" value="GRANT" class="btn btn-info btn-block font-weight-bold shadow-sm mb-2 rounded-pill">
                            <i class="fas fa-user-plus mr-1"></i> Bổ Nhiệm
                        </button>
                        <button type="submit" name="actionType" value="REVOKE" class="btn btn-light text-danger btn-block font-weight-bold border shadow-sm rounded-pill">
                            <i class="fas fa-user-times mr-1"></i> Bãi Nhiệm
                        </button>
                    </div>
                </div>
                <div class="text-center">
                    <small class="text-muted"><i class="fas fa-info-circle mr-1"></i> <strong>Bổ nhiệm:</strong> Nhân viên sẽ nhận tất cả quyền hạn đi kèm chức vụ này.</small>
                </div>
            }
        </div>
    </div>
</div>

<!-- MODAL HIỂN THỊ DANH SÁCH USER TRONG ROLE -->
<div class="modal fade" id="modalUsersInRole" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-users mr-2"></i>Thành viên chức vụ</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div class="p-3 bg-light border-bottom">
                    <strong class="text-muted">Đang xem:</strong> <span id="lblRoleName" class="text-info font-weight-bold ml-1">...</span>
                </div>
                <ul class="list-group list-group-flush" id="listUsersInRole" style="max-height: 300px; overflow-y: auto;">
                    <!-- Danh sách user sẽ được nạp vào đây -->
                </ul>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        // Logic UI: Đổi màu Card khi Click
        $('.permission-checkbox').change(function() {
            var card = $(this).closest('.permission-card');
            if ($(this).is(':checked')) {
                card.addClass('active-card');
                card.find('.check-indicator').show();
            } else {
                card.removeClass('active-card');
                card.find('.check-indicator').hide();
            }
        });

        // Trigger cho Dropdown Bảng
        $("#SelectedTable").change(checkExistingPrivileges);
    });

    // Logic Reset
    function resetRole() { if ($("#ddlUser").val() !== "") $("#ddlRole")[0].selectedIndex = 0; checkExistingPrivileges(); }
    function resetUser() { if ($("#ddlRole").val() !== "") $("#ddlUser")[0].selectedIndex = 0; checkExistingPrivileges(); }

    // AJAX: Lấy quyền hiện có
    function checkExistingPrivileges() {
        var user = $("#ddlUser").val();
        var role = $("#ddlRole").val();
        var table = $("#SelectedTable").val();
        var target = user || role;
        var displayDiv = $("#existingPrivilegesDisplay");

        if (!target || !table) {
            displayDiv.html('<span class="badge badge-soft-secondary p-2">Đang chờ chọn...</span>');
            return;
        }

        $.ajax({
            url: '@Url.Action("GetExistingPrivileges", "Admin")',
            type: "GET",
            data: { target: target, tableName: table },
            beforeSend: function() { displayDiv.html('<span class="spinner-border spinner-border-sm text-primary"></span> Đang kiểm tra...'); },
            success: function(res) {
                if (res.success) {
                    var html = '';
                    if (res.data.length === 0) {
                        html = '<span class="badge badge-soft-secondary p-2 px-3">Chưa có quyền nào</span>';
                    } else {
                        $.each(res.data, function(i, v) {
                            var vnText = v;
                            var badgeClass = "badge-soft-secondary";
                            if(v === 'SELECT') { vnText = 'Được Xem'; badgeClass = "badge-soft-primary"; }
                            if(v === 'INSERT') { vnText = 'Được Thêm'; badgeClass = "badge-soft-success"; }
                            if(v === 'UPDATE') { vnText = 'Được Sửa'; badgeClass = "badge-soft-warning"; }
                            if(v === 'DELETE') { vnText = 'Được Xóa'; badgeClass = "badge-soft-danger"; }
                            html += '<span class="badge ' + badgeClass + ' p-2 px-3 mr-2 mb-1 border">' + vnText + '</span>';
                        });
                    }
                    displayDiv.html(html);
                }
            }
        });
    }

    // AJAX: Xem user của Role
    function showUsersInRole() {
        var roleName = $("#roleToGrant").val();
        if (!roleName) {
            alert("Vui lòng chọn chức vụ trước khi xem danh sách!");
            return;
        }

        $("#lblRoleName").text(roleName);
        var listContainer = $("#listUsersInRole");
        listContainer.html('<li class="list-group-item text-center text-muted py-4"><span class="spinner-border spinner-border-sm text-info"></span> Đang tải dữ liệu...</li>');
        $("#modalUsersInRole").modal("show");

        $.ajax({
            url: '@Url.Action("GetUsersInRole", "Admin")',
            type: "GET",
            data: { roleName: roleName },
            success: function(res) {
                listContainer.empty();
                if (res.success) {
                    if (res.data.length > 0) {
                        $.each(res.data, function(i, user) {
                            var html = `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span class="font-weight-bold text-dark">
                                        <i class="fas fa-user-tie text-secondary mr-2"></i>${user}
                                    </span>
                                    <span class="badge badge-soft-success border"><i class="fas fa-check-circle"></i> Đang giữ</span>
                                </li>`;
                            listContainer.append(html);
                        });
                    } else {
                        listContainer.html('<li class="list-group-item text-center text-muted py-4"><i class="fas fa-user-slash fa-2x mb-2 d-block opacity-50"></i>Chưa có nhân viên nào giữ chức vụ này.</li>');
                    }
                } else {
                    listContainer.html('<li class="list-group-item text-danger text-center">' + res.message + '</li>');
                }
            },
            error: function() {
                listContainer.html('<li class="list-group-item text-danger text-center">Lỗi kết nối Server.</li>');
            }
        });
    }
</script>

<style>
    /* --- CSS CHO CARD UI --- */
    .permission-card {
        position: relative;
        border: 2px solid #e3e6f0;
        background: #fff;
        transition: all 0.2s;
    }

        .permission-card .check-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }

    .active-card {
        border-color: #4e73df !important;
        background-color: #f0f8ff !important;
    }

    .hover-shadow:hover {
        transform: translateY(-3px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    /* --- CSS CHO SOFT BADGES --- */
    .badge-soft-primary {
        background-color: #e3f2fd;
        color: #0d47a1;
        border-color: #90caf9 !important;
    }

    .badge-soft-success {
        background-color: #e8f5e9;
        color: #1b5e20;
        border-color: #a5d6a7 !important;
    }

    .badge-soft-warning {
        background-color: #fff3e0;
        color: #e65100;
        border-color: #ffcc80 !important;
    }

    .badge-soft-danger {
        background-color: #ffebee;
        color: #b71c1c;
        border-color: #ef9a9a !important;
    }

    .badge-soft-secondary {
        background-color: #f5f5f5;
        color: #616161;
        border-color: #e0e0e0 !important;
    }

    /* --- UTILS --- */
    .text-xs {
        font-size: .75rem;
    }

    .font-weight-600 {
        font-weight: 600;
    }

    .form-control:focus {
        box-shadow: none;
        border-color: #4e73df;
    }

    .btn-lg {
        padding: .75rem 1.5rem;
    }
</style>