@model UserApp.Models.GrantViewModel

@{
    ViewBag.Title = "Phân Quyền User";

    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<div class="container-fluid fade-in-up">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            @using (Html.BeginForm("PhanQuyen", "Admin", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                @Html.AntiForgeryToken()

                <div class="card shadow-lg border-0 rounded-lg mt-4">

                    <div class="card-header bg-gradient-primary text-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 font-weight-bold">
                                <i class="fas fa-shield-alt mr-2"></i>Hệ Thống Phân Quyền Oracle
                            </h4>
                            <span class="badge badge-light text-primary px-3 py-2 shadow-sm">
                                <i class="fas fa-link mr-1"></i> Connected
                            </span>
                        </div>
                    </div>

                    <div class="card-body p-5">

                        <div class="row mb-4">

                            <div class="col-md-6 border-right">
                                <h5 class="text-primary mb-3"><i class="fas fa-users-cog mr-2"></i>1. Chọn Đối Tượng Nhận Quyền</h5>

                                <div class="form-group bg-light p-3 rounded border">
                                    <label class="font-weight-bold text-dark">User hệ thống (DBA_USERS)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        </div>
                                        @Html.DropDownListFor(m => m.SelectedUser, new SelectList(Model.Users), "-- Chọn User --", new
                                        {
                                            @class = "form-control select-hover",
                                            id = "ddlUser",
                                            onchange = "resetRole()"
                                        })
                                    </div>
                                    <small class="form-text text-muted">Chọn User cụ thể để cấp quyền.</small>
                                </div>

                                <div class="text-center my-2 text-muted font-weight-bold">- HOẶC -</div>

                                <div class="form-group bg-light p-3 rounded border">
                                    <label class="font-weight-bold text-dark">Nhóm quyền (DBA_ROLES)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        </div>
                                        @Html.DropDownListFor(m => m.SelectedRole, new SelectList(Model.Roles), "-- Chọn Role --", new
                                        {
                                            @class = "form-control select-hover",
                                            id = "ddlRole",
                                            onchange = "resetUser()"
                                        })
                                    </div>
                                    <small class="form-text text-muted">Chọn Role để áp dụng cho nhiều user.</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="text-success mb-3"><i class="fas fa-database mr-2"></i>2. Chọn Bảng Dữ Liệu</h5>

                                <div class="form-group p-4 bg-light rounded border h-75 d-flex flex-column justify-content-center">
                                    <label class="font-weight-bold text-dark">Danh sách bảng (DBA_TABLES)</label>
                                    <div class="input-group mb-3">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-table"></i></span>
                                        </div>
                                        @Html.DropDownListFor(m => m.SelectedTable, new SelectList(Model.Tables), "-- Chọn Bảng --", new
                                        {
                                            @class = "form-control form-control-lg border-success",
                                            id = "SelectedTable",
                                            style = "height: 50px;"
                                        })
                                    </div>
                                    <div class="alert alert-info py-2 small shadow-sm">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Hệ thống đã tự động lọc bỏ các bảng hệ thống (SYS, SYSTEM...) để hiển thị danh sách gọn hơn.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row justify-content-center">
                            <div class="col-12 text-center">
                                <h5 class="text-secondary text-uppercase font-weight-bold mb-4">
                                    <i class="fas fa-tasks mr-2"></i>3. Chọn quyền hạn thao tác
                                </h5>

                                <div class="d-flex justify-content-center flex-wrap gap-custom">
                                    <div class="custom-control custom-checkbox custom-control-lg scale-checkbox mx-3">
                                        @Html.CheckBoxFor(m => m.Select, new { @class = "custom-control-input", id = "chkSelect" })
                                        <label class="custom-control-label font-weight-bold text-primary" for="chkSelect">SELECT</label>
                                    </div>

                                    <div class="custom-control custom-checkbox custom-control-lg scale-checkbox mx-3">
                                        @Html.CheckBoxFor(m => m.Insert, new { @class = "custom-control-input", id = "chkInsert" })
                                        <label class="custom-control-label font-weight-bold text-success" for="chkInsert">INSERT</label>
                                    </div>

                                    <div class="custom-control custom-checkbox custom-control-lg scale-checkbox mx-3">
                                        @Html.CheckBoxFor(m => m.Update, new { @class = "custom-control-input", id = "chkUpdate" })
                                        <label class="custom-control-label font-weight-bold text-warning" for="chkUpdate">UPDATE</label>
                                    </div>

                                    <div class="custom-control custom-checkbox custom-control-lg scale-checkbox mx-3">
                                        @Html.CheckBoxFor(m => m.Delete, new { @class = "custom-control-input", id = "chkDelete" })
                                        <label class="custom-control-label font-weight-bold text-danger" for="chkDelete">DELETE</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">

                        <div class="row justify-content-center mb-4">
                            <div class="col-12 text-center">
                                <h5 class="text-info text-uppercase font-weight-bold mb-3">
                                    <i class="fas fa-eye mr-2"></i>QUYỀN HẠN HIỆN CÓ
                                </h5>
                                <div id="existingPrivilegesDisplay" class="p-3 bg-light rounded border shadow-sm">
                                    <p class="text-muted mb-0">Vui lòng chọn **Đối Tượng Nhận Quyền** và **Bảng Dữ Liệu** để xem.</p>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">

                        @if (!string.IsNullOrEmpty(Model.Message))
                        {
                            <div class="row justify-content-center">
                                <div class="col-md-8">
                                    <div class="alert @(Model.MessageType == "success" ? "alert-success" : (Model.MessageType == "warning" ? "alert-warning" : "alert-danger")) shadow text-center" role="alert">
                                        @if (Model.MessageType == "success")
                                        {<i class="fas fa-check-circle fa-2x d-block mb-2"></i> }
                                        else if (Model.MessageType == "warning")
                                        { <i class="fas fa-exclamation-circle fa-2x d-block mb-2"></i> }
                                        else
                                        { <i class="fas fa-times-circle fa-2x d-block mb-2"></i>}

                                        <strong>@Model.Message</strong>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="row mt-3">
                            <div class="col-md-6 mb-2">
                                <button type="submit" name="actionType" value="GRANT" class="btn btn-primary btn-block btn-lg shadow hover-lift">
                                    <i class="fas fa-lock mr-2"></i> CẤP QUYỀN (GRANT)
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="submit" name="actionType" value="REVOKE" class="btn btn-outline-danger btn-block btn-lg shadow-sm hover-lift">
                                    <i class="fas fa-unlock-alt mr-2"></i> THU HỒI (REVOKE)
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            } <hr class="my-5">

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card shadow-lg border-info h-100">
                        <div class="card-header bg-info text-white font-weight-bold">
                            <i class="fas fa-plus-circle mr-2"></i>Chức Năng: Tạo Role Mới
                        </div>
                        <div class="card-body">
                            @using (Html.BeginForm("CreateRole", "Admin", FormMethod.Post, new { role = "form", @class = "needs-validation" }))
                            {
                                @Html.AntiForgeryToken()
                                <p class="text-muted small">Tạo một nhóm quyền mới trong hệ thống Oracle (ví dụ: KETOAN_ROLE).</p>
                                <div class="form-group">
                                    @Html.LabelFor(m => m.NewRoleName, "Tên Role:", new { @class = "control-label font-weight-bold" })
                                    @Html.TextBoxFor(m => m.NewRoleName, new { @class = "form-control", placeholder = "Nhập tên Role (Ví dụ: KETOAN_ROLE)", required = "required" })
                                </div>
                                <button type="submit" class="btn btn-info btn-block mt-3 shadow-sm hover-lift">
                                    <i class="fas fa-hammer mr-2"></i>Tạo Role
                                </button>
                            }
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card shadow-lg border-success h-100">
                        <div class="card-header bg-success text-white font-weight-bold">
                            <i class="fas fa-user-plus mr-2"></i>Chức Năng: Gán Role cho User
                        </div>
                        <div class="card-body">
                            @using (Html.BeginForm("AssignRole", "Admin", FormMethod.Post, new { role = "form", @class = "needs-validation" }))
                            {
                                @Html.AntiForgeryToken()
                                <p class="text-muted small">Cấp Role hiện có cho một User cụ thể.</p>

                                <div class="form-group">
                                    @Html.LabelFor(m => m.UserToAssign, "Chọn User:", new { @class = "control-label font-weight-bold" })
                                    @Html.DropDownListFor(m => m.UserToAssign, new SelectList(Model.Users), "-- Chọn User --", new { @class = "form-control select-hover", required = "required" })
                                </div>

                                <div class="form-group">
                                    @Html.LabelFor(m => m.RoleToAssign, "Chọn Role:", new { @class = "control-label font-weight-bold" })
                                    @Html.DropDownListFor(m => m.RoleToAssign, new SelectList(Model.Roles), "-- Chọn Role --", new { @class = "form-control select-hover", required = "required" })
                                </div>

                                <button type="submit" class="btn btn-success btn-block mt-3 shadow-sm hover-lift">
                                    <i class="fas fa-link mr-2"></i>Gán Role
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Khi chọn User thì reset Role về mặc định VÀ kiểm tra quyền
    function resetRole() {
        var userVal = document.getElementById("ddlUser").value;
        if (userVal !== "") {
            document.getElementById("ddlRole").selectedIndex = 0;
        }
        checkExistingPrivileges();
    }

    // Khi chọn Role thì reset User về mặc định VÀ kiểm tra quyền
    function resetUser() {
        var roleVal = document.getElementById("ddlRole").value;
        if (roleVal !== "") {
            document.getElementById("ddlUser").selectedIndex = 0;
        }
        checkExistingPrivileges();
    }

 
    function checkExistingPrivileges() {
        var user = $("#ddlUser").val();
        var role = $("#ddlRole").val();
        var table = $("#SelectedTable").val(); 

        var target = user || role;
        var displayDiv = $("#existingPrivilegesDisplay");
        if (!target || !table) {
            displayDiv.html('<p class="text-muted mb-0">Vui lòng chọn **Đối Tượng Nhận Quyền** và **Bảng Dữ Liệu** để xem.</p>');
            return;
        }
        $.ajax({
            url: '@Url.Action("GetExistingPrivileges", "Admin")',
            type: "GET",
            data: { target: target, tableName: table },
            beforeSend: function() {
                displayDiv.html('<i class="fas fa-spinner fa-spin mr-2"></i> Đang tải quyền...');
            },
            success: function(response) {
                if (response.success) {
                    var privs = response.data;
                    var htmlContent = '';

                    if (!privs || privs.length === 0) {   
                        htmlContent = '<span class="badge badge-secondary p-2 shadow-sm text-dark">Chưa có quyền nào</span>';
                    } else {
                        $.each(privs, function(index, value) {
                            var badgeClass = 'badge-light text-dark border'; 
                            htmlContent += '<span class="badge ' + badgeClass + ' p-2 mx-1 shadow-sm font-weight-bold scale-checkbox">' + value + '</span>';
                        });
                    }
                    displayDiv.html(htmlContent);
                } else {
                    displayDiv.html('<p class="text-danger mb-0">Lỗi: ' + response.message + '</p>');
                }
            },
            error: function(xhr, status, error) {
                displayDiv.html('<p class="text-danger mb-0">Lỗi kết nối Server: ' + error + '</p>');
            }
        });
    }

    // Gắn sự kiện thay đổi cho Dropdown Bảng
    $(document).ready(function() {
        $("#SelectedTable").on("change", checkExistingPrivileges);

        // Gọi lần đầu khi trang load nếu đã có sẵn dữ liệu
        checkExistingPrivileges();
    });
</script>

<style>
    /* Hiệu ứng load trang */
    .fade-in-up {
        animation: fadeInUp 0.5s ease-out;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }


    /* Tăng kích thước checkbox */
    .scale-checkbox {
        transform: scale(1.2);
        cursor: pointer;
    }

    /* Hiệu ứng nút bấm */
    .hover-lift {
        transition: transform 0.2s;
    }

        .hover-lift:hover {
            transform: translateY(-2px);
        }

    /* Màu nền gradient cho header */
    .bg-gradient-primary {
        background: linear-gradient(45deg, #4e73df 0%, #224abe 100%);
    }

    .gap-custom {
        gap: 20px;
    }
</style>